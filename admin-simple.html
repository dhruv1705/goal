<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals App - Simple Admin Panel</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #1a1a1a;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #7C3AED;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .step-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .step-number {
            background: #7C3AED;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .sql-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            margin: 15px 0;
            overflow-x: auto;
        }

        .btn {
            background: #7C3AED;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        .btn:hover {
            background: #6D28D9;
        }

        .btn-success {
            background: #10B981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #EF4444;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #7C3AED;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #f0fdf4;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .alert-warning {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .hidden {
            display: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f9fafb;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .status-active { background: #10b981; }
        .status-completed { background: #7c3aed; }
        .status-paused { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Goals App - Simple Admin Panel</h1>
            <p>Follow the steps below to get your admin panel working</p>
        </div>

        <!-- Step 1: Fix Database Policies -->
        <div class="step-section">
            <div class="step-title">
                <span class="step-number">1</span>
                Fix Database RLS Policies
            </div>
            <p>The admin panel isn't working because of Row Level Security (RLS) policies. We need to fix this in Supabase:</p>
            
            <ol style="margin: 15px 0 15px 20px;">
                <li>Go to your <strong>Supabase Dashboard</strong></li>
                <li>Click on <strong>SQL Editor</strong> in the left sidebar</li>
                <li>Copy and paste this SQL code:</li>
            </ol>

            <div class="sql-box">-- Temporarily disable RLS for admin access
ALTER TABLE public.goals DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.schedules DISABLE ROW LEVEL SECURITY;

-- Grant permissions to anon role
GRANT ALL ON public.goals TO anon;
GRANT ALL ON public.schedules TO anon;</div>

            <ol start="4" style="margin: 15px 0 15px 20px;">
                <li>Click <strong>"Run"</strong> to execute the SQL</li>
                <li>You should see "Success. No rows returned" message</li>
                <li>Click the button below to test the connection</li>
            </ol>

            <button class="btn" onclick="testDatabaseConnection()">Test Database Connection</button>
            <div id="connectionResult"></div>
        </div>

        <!-- Step 2: Admin Dashboard -->
        <div class="step-section">
            <div class="step-title">
                <span class="step-number">2</span>
                Admin Dashboard
            </div>
            
            <div id="dashboardSection" class="hidden">
                <div class="dashboard">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalGoals">0</div>
                        <div class="stat-label">Total Goals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedGoals">0</div>
                        <div class="stat-label">Completed Goals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeSchedules">0</div>
                        <div class="stat-label">Active Schedules</div>
                    </div>
                </div>

                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="createSampleData()">Create Sample Data</button>
                    <button class="btn" onclick="refreshData()">Refresh Data</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>

                <div id="goalsTableContainer">
                    <h3>Recent Goals:</h3>
                    <table class="data-table" id="goalsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="goalsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Step 3: Re-enable Security -->
        <div class="step-section">
            <div class="step-title">
                <span class="step-number">3</span>
                Re-enable Security (After Testing)
            </div>
            <p>Once you're done testing the admin panel, you should re-enable RLS for security:</p>
            
            <div class="sql-box">-- Re-enable RLS for security
ALTER TABLE public.goals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.schedules ENABLE ROW LEVEL SECURITY;</div>
            
            <p><strong>Note:</strong> You can keep RLS disabled for now if this is just a development/testing environment.</p>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://ebdvpahpuefimdcfuvru.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViZHZwYWhwdWVmaW1kY2Z1dnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMjM5NTMsImV4cCI6MjA2Njc5OTk1M30.8V52GocdThP5StIJ5ImZL3PwXPD8QWkJsj465QA2vI4'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div')
            alertDiv.className = `alert alert-${type}`
            alertDiv.innerHTML = message
            document.getElementById('connectionResult').appendChild(alertDiv)
            
            setTimeout(() => {
                alertDiv.remove()
            }, 10000)
        }

        async function testDatabaseConnection() {
            document.getElementById('connectionResult').innerHTML = ''
            
            try {
                // Test reading goals
                const { data: goals, error: goalsError } = await supabase
                    .from('goals')
                    .select('*')
                    .limit(1)

                if (goalsError) {
                    showAlert(`❌ Cannot read goals table: ${goalsError.message}. Please run the SQL commands in Step 1.`, 'error')
                    return
                }

                // Test inserting a goal
                const testGoal = {
                    title: 'Test Goal - DELETE ME',
                    user_id: crypto.randomUUID(),
                    status: 'active',
                    category: 'Testing'
                }

                const { data: insertData, error: insertError } = await supabase
                    .from('goals')
                    .insert(testGoal)
                    .select()

                if (insertError) {
                    showAlert(`❌ Cannot insert goals: ${insertError.message}. Please run the SQL commands in Step 1.`, 'error')
                    return
                }

                // Clean up test data
                if (insertData && insertData.length > 0) {
                    await supabase.from('goals').delete().eq('id', insertData[0].id)
                }

                showAlert('✅ Database connection successful! RLS is disabled and admin panel can work.', 'success')
                
                // Show dashboard
                document.getElementById('dashboardSection').classList.remove('hidden')
                await loadDashboard()

            } catch (error) {
                showAlert(`❌ Connection test failed: ${error.message}`, 'error')
            }
        }

        async function loadDashboard() {
            try {
                // Load goals
                const { data: goals, error: goalsError } = await supabase
                    .from('goals')
                    .select('*')

                if (goalsError) throw goalsError

                // Load schedules
                const { data: schedules, error: schedulesError } = await supabase
                    .from('schedules')
                    .select('*')

                if (schedulesError) {
                    console.log('Schedules table might not exist:', schedulesError.message)
                }

                const goalsData = goals || []
                const schedulesData = schedules || []

                // Update statistics
                const uniqueUsers = new Set(goalsData.map(g => g.user_id)).size
                const completedGoals = goalsData.filter(g => g.status === 'completed').length
                const activeSchedules = schedulesData.filter(s => !s.completed).length

                document.getElementById('totalUsers').textContent = uniqueUsers
                document.getElementById('totalGoals').textContent = goalsData.length
                document.getElementById('completedGoals').textContent = completedGoals
                document.getElementById('activeSchedules').textContent = activeSchedules

                // Update table
                const tbody = document.getElementById('goalsTableBody')
                tbody.innerHTML = ''

                if (goalsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No goals found. Create sample data to test the admin panel.</td></tr>'
                } else {
                    goalsData.slice(0, 10).forEach(goal => {
                        const row = document.createElement('tr')
                        row.innerHTML = `
                            <td>${goal.title}</td>
                            <td>${goal.category || 'None'}</td>
                            <td><span class="status-badge status-${goal.status}">${goal.status}</span></td>
                            <td>${new Date(goal.created_at).toLocaleDateString()}</td>
                        `
                        tbody.appendChild(row)
                    })
                }

            } catch (error) {
                showAlert(`Error loading dashboard: ${error.message}`, 'error')
            }
        }

        async function createSampleData() {
            try {
                const sampleGoals = [
                    { title: 'Learn React Native', description: 'Master mobile app development', category: 'Learning', status: 'active', user_id: crypto.randomUUID() },
                    { title: 'Run 5K Daily', description: 'Improve cardiovascular health', category: 'Health', status: 'active', user_id: crypto.randomUUID() },
                    { title: 'Read 12 Books', description: 'Expand knowledge', category: 'Personal', status: 'active', user_id: crypto.randomUUID() },
                    { title: 'Save $10,000', description: 'Build emergency fund', category: 'Finance', status: 'completed', user_id: crypto.randomUUID() },
                    { title: 'Get Promotion', description: 'Advance career', category: 'Career', status: 'active', user_id: crypto.randomUUID() }
                ]

                const { data, error } = await supabase
                    .from('goals')
                    .insert(sampleGoals)
                    .select()

                if (error) throw error

                showAlert(`✅ Successfully created ${data.length} sample goals!`, 'success')
                await loadDashboard()

            } catch (error) {
                showAlert(`❌ Error creating sample data: ${error.message}`, 'error')
            }
        }

        async function refreshData() {
            await loadDashboard()
            showAlert('✅ Data refreshed!', 'success')
        }

        async function clearAllData() {
            const confirmed = confirm('This will delete ALL goals and schedules. Continue?')
            if (!confirmed) return

            try {
                const { error: goalsError } = await supabase.from('goals').delete().neq('id', '')
                if (goalsError) throw goalsError

                const { error: schedulesError } = await supabase.from('schedules').delete().neq('id', '')
                // Ignore schedules error if table doesn't exist

                showAlert('✅ All data cleared!', 'success')
                await loadDashboard()

            } catch (error) {
                showAlert(`❌ Error clearing data: ${error.message}`, 'error')
            }
        }
    </script>
</body>
</html>